#!/bin/bash

shopt -s nullglob

for esp in /dev/disk/by-partlabel/<%= scope['trusted']['certname'] %>-efi*; do
    mkdir /boot/efi
    mount "$esp" /boot/efi
    /usr/sbin/grub2-install --target=x86_64-efi --removable --modules=part_gpt
    umount /boot/efi
    rm -rf /boot/efi
done

for bios_part in /dev/disk/by-partlabel/<%= scope['trusted']['certname'] %>-bios*; do
    eval `lsblk --inverse --pairs --paths --output NAME "$bios_part"`
    /usr/sbin/grub2-install --target=i386-pc --modules=part_gpt "$NAME"
done

---
nest::cflags: '-march=haswell -O2 -pipe -ggdb'
nest::cpu_flags_x86: 'aes avx avx2 fma3 mmx mmxext popcnt sse sse2 sse3 sse4_1 sse4_2 ssse3'
nest::use: ['numa']

nest::package_keywords:
  sys-kernel/dracut:
    version: '=044'

  # For better systemd units
  net-fs/nfs-utils:
    version: '=1.3.3'

  # More reliable than 1.98
  sys-auth/pam_ssh:
    version: '=2.1'

  # hiera-eyaml
  dev-ruby/hiera-eyaml:
    version: '=2.1.0'
  dev-ruby/trollop:
    version: '=2.1.2'

  # ZFS
  sys-kernel/spl:
    version: '=0.7.1'
  sys-fs/zfs-kmod:
    version: '=0.7.1'
  sys-fs/zfs:
    version: '=0.7.1'

  # For better Skylake support
  # XXX: Removed due to package stabilization
  sys-kernel/gentoo-sources:
    version: '=4.8.9'
    ensure: 'absent'
  sys-kernel/linux-firmware:
    version: '=20161005'
    ensure: 'absent'

  # To support Linux 4.6
  x11-drivers/nvidia-drivers:
    slot: '0/375'

  # beets
  dev-python/jellyfish:
    version: '=0.5.6'
  dev-python/munkres:
    version: '=1.0.5.4-r2'
  media-sound/beets: {}

  # nc: all versions are unstable; don't care
  net-analyzer/openbsd-netcat: {}

  # I want some of the latest changes re: mouse support and key bindings
  # (accept tmux-2.3; 2.4 is unstable)
  app-misc/tmux:
    version: '<2.4'

  # needed to support libevent > 2.1 (pulled in by tmux-2.3)
  net-fs/nfs-utils:
    version: '=2.1.1'

  # Let's Encrypt: all versions are currently unstable
  app-crypt/acme: {}
  app-crypt/certbot: {}
  dev-python/parsedatetime:
    version: '=2.1'
  dev-python/pyrfc3339:
    version: '=1.0'
  dev-python/zope-component:
    version: '=4.3.0'

  # For Wordpress SFTP; the version that supports PHP 7 is unstable
  dev-php/pecl-ssh2:
    version: '=9999'
    keywords: '**'

  # Required by dev-java/icedtea-bin-3.3.0[-headless-awt,-multilib]
  media-libs/libpng:
    version: '=1.6.34'

nest::package_use:
  # For Dracut liveimg module
  net-misc/iputils:
    use: 'arping'

  # Ordinarily I'd define this in the appropriate profile class,
  # but since they are included as part of the profile, we
  # want to have these use flag set early in the run, which this
  # accomplishes.
  sys-apps/systemd:
    use: 'cryptsetup'
  sys-auth/pambase:
    use: 'pam_ssh'
    ensure: 'absent'

  # For plymouth
  x11-libs/libdrm:
    use: 'libkms'

  # For samba
  sys-libs/ntdb:
    use: 'python'
  sys-libs/tdb:
    use: 'python'
  sys-libs/tevent:
    use: 'python'

  # For docker
  sys-libs/libseccomp:
    use: 'static-libs'

  # For some reason, apache w/ mod_proxy_fcgi won't compile without APR having
  # LDAP support
  dev-libs/apr-util:
    use: 'ldap'

  # For net-print/cups[X]
  app-text/xmlto:
    use: 'text'

  # To prevent ruby-2.2 from being pulled in--this is the only package
  # that seems to do this
  dev-ruby/trollop:
    use: '-ruby_targets_ruby22'
    ensure: 'absent'

nest::kernel_config:
  CONFIG_GENTOO_LINUX_INIT_SYSTEMD: y
  CONFIG_NUMA_BALANCING: y
  CONFIG_USER_NS: y
  CONFIG_DEFAULT_CFQ: n
  CONFIG_DEFAULT_NOOP: y
  CONFIG_DEFAULT_IOSCHED: 'noop'
  CONFIG_X86_X2APIC: y
  CONFIG_MCORE2: y
  CONFIG_GENERIC_CPU: n
  CONFIG_X86_INTEL_PSTATE: y
  CONFIG_INTEL_IDLE: y
  CONFIG_PCI_STUB: y
  CONFIG_X86_SYSFB: y
  CONFIG_NETFILTER_XT_MATCH_COMMENT: m
  CONFIG_NETFILTER_XT_MATCH_MULTIPORT: m
  CONFIG_NETFILTER_XT_MATCH_PKTTYPE: m
  CONFIG_BRIDGE: m
  CONFIG_BLK_DEV_NVME: m
  CONFIG_SCSI_LOWLEVEL: y
  CONFIG_SCSI_AACRAID: m
  CONFIG_SCSI_VIRTIO: m
  CONFIG_MD_RAID1: m
  CONFIG_DM_CRYPT: m
  CONFIG_DM_SNAPSHOT: m
  CONFIG_DM_THIN_PROVISIONING: m
  CONFIG_BT: m
  CONFIG_BT_RFCOMM: m
  CONFIG_BT_HIDP: m
  CONFIG_BT_HCIBTUSB: m
  CONFIG_TUN: m
  CONFIG_E1000E: m
  CONFIG_IGB: m
  CONFIG_IWLWIFI: m
  CONFIG_IWLMVM: m
  CONFIG_HW_RANDOM_VIRTIO: m
  CONFIG_I2C_CHARDEV: m
  CONFIG_MFD_RTSX_PCI: m
  CONFIG_DRM_I915: m
  CONFIG_FB_SIMPLE: y
  CONFIG_LOGO: n
  CONFIG_SND_DYNAMIC_MINORS: y
  CONFIG_SND_HDA_PREALLOC_SIZE: 2048
  CONFIG_SND_HDA_CODEC_REALTEK: y
  CONFIG_SND_HDA_CODEC_HDMI: y
  CONFIG_SND_HDA_CODEC_CONEXANT: y
  CONFIG_SND_USB_AUDIO: m
  CONFIG_HID_BATTERY_STRENGTH: y
  CONFIG_UHID: m
  CONFIG_HID_LOGITECH_DJ: m
  CONFIG_USB_XHCI_HCD: m
  CONFIG_VFIO: m
  CONFIG_VFIO_PCI: m
  CONFIG_VIRTIO_BALLOON: m
  CONFIG_THINKPAD_ACPI: m
  CONFIG_IRQ_REMAP: y
  CONFIG_FSCACHE: y
  CONFIG_CACHEFILES: m
  CONFIG_SQUASHFS: m
  CONFIG_SQUASHFS_XZ: y
  CONFIG_NFS_V4_1: y
  CONFIG_NFS_V4_2: y
  CONFIG_NFS_FSCACHE: y
  CONFIG_NFSD: m
  CONFIG_NFSD_V4: y
  CONFIG_CRYPTO_XTS: m
  CONFIG_CRYPTO_AES_NI_INTEL: m
  CONFIG_CRYPTO_SERPENT: m
  CONFIG_CRYPTO_SERPENT_SSE2_X86_64: m
  CONFIG_CRYPTO_SERPENT_AVX_X86_64: m
  CONFIG_CRYPTO_SERPENT_AVX2_X86_64: m
  CONFIG_CRYPTO_TWOFISH: m
  CONFIG_CRYPTO_TWOFISH_COMMON: m
  CONFIG_CRYPTO_TWOFISH_X86_64: m
  CONFIG_CRYPTO_TWOFISH_X86_64_3WAY: m
  CONFIG_CRYPTO_TWOFISH_AVX_X86_64: m
  CONFIG_CRYPTO_USER_API_SKCIPHER: m
  CONFIG_CRYPTO_DEFLATE: m  # for ZLIB_DEFLATE, an spl requirement
  CONFIG_KVM: m
  CONFIG_KVM_INTEL: m
  CONFIG_VHOST_NET: m

  # For libvirt
  CONFIG_MEMCG: y
  CONFIG_MEMCG_SWAP: y
  CONFIG_BRIDGE_NF_EBTABLES: m
  CONFIG_BRIDGE_EBT_T_NAT: m
  CONFIG_BRIDGE_EBT_MARK_T: m
  CONFIG_NETFILTER_ADVANCED: y
  CONFIG_NETFILTER_XT_TARGET_CHECKSUM: m
  CONFIG_NETFILTER_XT_CONNMARK: m
  CONFIG_NET_SCH_HTB: m
  CONFIG_NET_SCH_SFQ: m
  CONFIG_NET_SCH_INGRESS: m
  CONFIG_NET_CLS_FW: m
  CONFIG_NET_CLS_U32: m
  CONFIG_NET_ACT_POLICE: m
  CONFIG_MACVLAN: m
  CONFIG_MACVTAP: m

  # For docker
  CONFIG_CFS_BANDWIDTH: y
  CONFIG_BLK_CGROUP: y
  CONFIG_CGROUP_DEVICE: y
  CONFIG_CGROUP_HUGETLB: y
  CONFIG_CGROUP_PERF: y
  CONFIG_NET_CLS_CGROUP: m
  CONFIG_CGROUP_NET_PRIO: y
  CONFIG_VETH: m

  # For powertop
  CONFIG_CPU_FREQ_STAT: y

  # Allow kernel ticks to be disabled on cpus specified at the command line
  # (for certain virtualization workloads)
  CONFIG_NO_HZ_IDLE: n
  CONFIG_NO_HZ_FULL: y
